<div class="user-management-container">
  <h1>Gestión de Usuarios</h1>
  
  <div class="alert info-alert" *ngIf="message">
    {{ message }}
  </div>
  
  <div class="alert error-alert" *ngIf="error">
    {{ error }}
  </div>
  
  <div class="loading-indicator" *ngIf="loading && loadingGroups && loadingPermissions">
    Cargando datos...
  </div>
  
  <!-- Tabs de navegación -->
  <div class="management-tabs" *ngIf="!(loading && loadingGroups && loadingPermissions)">
    <div 
      class="tab" 
      [class.active-tab]="activeTab === 'roles'"
      (click)="setActiveTab('roles')"
    >
      Roles
    </div>
    <div 
      class="tab" 
      [class.active-tab]="activeTab === 'groups'"
      (click)="setActiveTab('groups')"
    >
      Grupos
    </div>
    <div 
      class="tab" 
      [class.active-tab]="activeTab === 'permissions'"
      (click)="setActiveTab('permissions')"
    >
      Permisos
    </div>
    <div 
      class="tab" 
      [class.active-tab]="activeTab === 'group-permissions'"
      (click)="setActiveTab('group-permissions')"
    >
      Asignar Permisos
    </div>
  </div>
  
  <!-- Tab de Roles (Vista original) -->
  <div *ngIf="activeTab === 'roles' && !loading && users.length > 0">
    <table class="users-table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Estado</th>
          <th>Roles</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users" [class.disabled-user]="!isUserEnabled(user)">
          <td>{{ user.username }}</td>
          <td>
            <span class="user-status" [class.status-enabled]="isUserEnabled(user)" [class.status-disabled]="!isUserEnabled(user)">
              {{ isUserEnabled(user) ? 'Habilitado' : 'Deshabilitado' }}
            </span>
          </td>
          <td>
            <div class="role-badges">
              <span 
                *ngFor="let role of user.roles" 
                class="role-badge"
                [class.admin-role]="role === 'ADMIN'"
                [class.user-role]="role === 'USER'"
              >
                {{ role }}
              </span>
            </div>
          </td>
          <td>
            <div class="role-actions">
              <div class="role-checkboxes">
                <div class="checkbox-group">
                  <label>
                    <input 
                      type="checkbox" 
                      [(ngModel)]="selectedRoles[user.id!][UserRole.ADMIN]"
                      [disabled]="isSuperAdmin(user)"
                      [checked]="isSuperAdmin(user) || selectedRoles[user.id!][UserRole.ADMIN]"
                      (change)="onRoleChange(user)"
                    />
                    Administrador
                  </label>
                </div>
                <div class="checkbox-group">
                  <label>
                    <input 
                      type="checkbox"
                      [(ngModel)]="selectedRoles[user.id!][UserRole.USER]"
                      [disabled]="isSuperAdmin(user) || selectedRoles[user.id!][UserRole.ADMIN]"
                      [checked]="isSuperAdmin(user) || selectedRoles[user.id!][UserRole.USER]"
                      (change)="onRoleChange(user)"
                    />
                    Usuario (Habilitado)
                  </label>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- Tab de Grupos Shape Up -->
  <div *ngIf="activeTab === 'groups' && !loading && users.length > 0">
    <table class="users-table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Estado</th>
          <th>Grupos</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users" [class.disabled-user]="!isUserEnabled(user)">
          <td>{{ user.username }}</td>
          <td>
            <span class="user-status" [class.status-enabled]="isUserEnabled(user)" [class.status-disabled]="!isUserEnabled(user)">
              {{ isUserEnabled(user) ? 'Habilitado' : 'Deshabilitado' }}
            </span>
          </td>
          <td>
            <div class="group-badges">
              <span 
                *ngFor="let group of user.groups" 
                class="group-badge"
              >
                {{ getGroupDisplayName(group) }}
              </span>
              <span *ngIf="!user.groups || user.groups.length === 0" class="no-groups">
                Sin grupos asignados
              </span>
            </div>
          </td>
          <td>
            <div class="group-actions">
              <div class="group-checkboxes">
                <div *ngFor="let groupType of ShapeUpGroup | keyvalue" class="checkbox-group">
                  <label>
                    <input 
                      type="checkbox"
                      [(ngModel)]="selectedGroups[user.id!][groupType.value]"
                      [disabled]="!isUserEnabled(user)"
                      (change)="onGroupChange(user)"
                    />
                    {{ getGroupDisplayName(groupType.value) }}
                  </label>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    
    <!-- Lista de Permisos por Grupo -->
    <div class="permissions-section" *ngIf="!loadingGroups && groups.length > 0">
      <h2>Permisos por Grupo</h2>
      <div class="permissions-list">
        <div *ngFor="let group of groups" class="permission-card">
          <h3>{{ getGroupDisplayName(group.id) }}</h3>
          <div *ngIf="group.description" class="group-description">
            {{ group.description }}
          </div>
          <div class="permissions">
            <div *ngIf="group.permissions.length === 0" class="no-permissions-message">
              Este grupo no tiene permisos asignados.
            </div>
            <div class="permission-badges" *ngIf="group.permissions.length > 0">
              <div *ngFor="let permission of group.permissions" class="permission-badge">
                <span class="permission-badge-name">{{ permission.name }}</span>
                <span class="permission-badge-id">{{ permission.id }}</span>
                <div *ngIf="permission.description" class="permission-badge-description">
                  {{ permission.description }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab de Gestión de Permisos -->
  <div *ngIf="activeTab === 'permissions' && !loadingPermissions">
    <div class="permissions-container">
      <div class="permissions-form-section">
        <h2>{{ editingPermission ? 'Editar Permiso' : 'Crear Nuevo Permiso' }}</h2>
        
        <form [formGroup]="permissionForm" (ngSubmit)="onSubmitPermission()" class="permission-form">
          <div class="form-field">
            <label for="name">Nombre de Permiso:</label>
            <input 
              type="text" 
              id="name" 
              formControlName="name" 
              placeholder="Ej: Gestionar Documentación"
            >
            <div *ngIf="permissionForm.get('name')?.invalid && permissionForm.get('name')?.touched" class="form-error">
              <span *ngIf="permissionForm.get('name')?.errors?.['required']">El nombre es obligatorio</span>
              <span *ngIf="permissionForm.get('name')?.errors?.['minlength']">El nombre debe tener al menos 3 caracteres</span>
            </div>
          </div>
          
          <div class="form-field">
            <label for="description">Descripción:</label>
            <textarea 
              id="description" 
              formControlName="description" 
              placeholder="Ej: Permite gestionar la documentación técnica del proyecto"
              rows="3"
            ></textarea>
            <div *ngIf="permissionForm.get('description')?.invalid && permissionForm.get('description')?.touched" class="form-error">
              La descripción es obligatoria
            </div>
          </div>
          
          <div class="form-actions">
            <button 
              type="submit" 
              [disabled]="permissionForm.invalid"
              class="primary-button"
            >
              {{ editingPermission ? 'Actualizar Permiso' : 'Crear Permiso' }}
            </button>
            
            <button 
              *ngIf="editingPermission"
              type="button" 
              class="secondary-button"
              (click)="resetPermissionForm()"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
      
      <div class="permissions-list-section">
        <h2>Permisos Disponibles</h2>
        
        <div *ngIf="permissions.length === 0" class="no-permissions-message">
          No hay permisos definidos. Crea el primero usando el formulario.
        </div>
        
        <table *ngIf="permissions.length > 0" class="permissions-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Descripción</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let permission of permissions">
              <td>{{ permission.id }}</td>
              <td>{{ permission.name }}</td>
              <td>{{ permission.description }}</td>
              <td>
                <div class="permission-actions">
                  <button 
                    class="edit-button"
                    (click)="editPermission(permission)"
                  >
                    Editar
                  </button>
                  <button 
                    class="delete-button"
                    (click)="deletePermission(permission.id)"
                  >
                    Eliminar
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Tab de Asignación de Permisos a Grupos -->
  <div *ngIf="activeTab === 'group-permissions' && !loadingGroups && !loadingPermissions">
    <div class="group-permissions-container">
      <div *ngIf="!selectedGroupForPermissions" class="group-selection-section">
        <h2>Selecciona un Grupo para Gestionar sus Permisos</h2>
        
        <div class="groups-grid">
          <div 
            *ngFor="let group of groups" 
            class="group-card"
            (click)="selectGroupForPermissions(group)"
          >
            <h3>{{ getGroupDisplayName(group.id) }}</h3>
            <p class="group-description">{{ group.description }}</p>
            <div class="group-permissions-count">
              {{ group.permissions.length }} permisos asignados
            </div>
          </div>
        </div>
      </div>
      
      <div *ngIf="selectedGroupForPermissions" class="group-permission-edit-section">
        <div class="edit-header">
          <h2>Gestionar Permisos del Grupo: {{ getGroupDisplayName(selectedGroupForPermissions) }}</h2>
          <button class="back-button" (click)="cancelEditGroupPermissions()">Volver a la lista de grupos</button>
        </div>
        
        <div *ngIf="permissions.length === 0" class="no-permissions-message">
          No hay permisos disponibles para asignar. Crea algunos primero en la pestaña de Permisos.
        </div>
        
        <div *ngIf="permissions.length > 0" class="permissions-selection">
          <div class="permissions-checkboxes">
            <div *ngFor="let permission of permissions" class="permission-checkbox-group">
              <label>
                <input 
                  type="checkbox"
                  [(ngModel)]="selectedGroupPermissions[selectedGroupForPermissions][permission.id]"
                />
                <div class="permission-details">
                  <span class="permission-name">{{ permission.name }}</span>
                  <span class="permission-id">({{ permission.id }})</span>
                  <p class="permission-description">{{ permission.description }}</p>
                </div>
              </label>
            </div>
          </div>
          
          <div class="permission-edit-actions">
            <button 
              class="primary-button"
              (click)="saveGroupPermissions()"
            >
              Guardar Permisos
            </button>
            <button 
              class="secondary-button"
              (click)="cancelEditGroupPermissions()"
            >
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="no-users-message" *ngIf="!loading && users.length === 0 && (activeTab === 'roles' || activeTab === 'groups')">
    No hay usuarios registrados.
  </div>
</div> 